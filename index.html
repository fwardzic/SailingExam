<!DOCTYPE html>
<html>
<head>
    <title>Żeglarz jachtowy egzamin pytania</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8" crossorigin="anonymous"></script>
    <script src="https://github.com/admirhodzic/multiselect-dropdown/blob/main/multiselect-dropdown.js" ></script>
    <style>
        .container {
            text-align: center;
            margin-top: 50px;
            font-size: 18px;
        }
        .question {
            margin-bottom: 20px;
        }
        .answers {
            margin-bottom: 20px;
        }
        .feedback {
            margin-bottom: 20px;
        }
        .next-button {
            margin-bottom: 20px;
        }
        .search-button {
            margin-bottom: 20px;
        }
        .hint {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="question" id="question"></div>
        <div id="imageContainer">
            <img id="questionImage" src="" alt="Question Image">
        </div>
        <div class="answers">
            <label for="answerA"><input type="radio" name="answer" value="A" id="answerA"> <span id="labelA"></span></label><br>
            <label for="answerB"><input type="radio" name="answer" value="B" id="answerB"> <span id="labelB"></span></label><br>
            <label for="answerC"><input type="radio" name="answer" value="C" id="answerC"> <span id="labelC"></span></label><br>
        </div>
        <button class="btn btn-primary" onclick="checkAnswer()">Check Answer</button>
        <div class="feedback" id="feedback"></div>
        <div class="hint" id="hint"></div>
        <button class="btn btn-primary" onclick="nextQuestion()">Next</button>
        <button class="btn btn-primary" onclick="searchQuestion()">Search in Google</button>
        <button class="btn btn-primary" onclick="showHint()" id="hintButton" style="display: none;">Show Hint</button>
        <p>Total Questions: <span id="totalQuestions">0</span></p>
        <p>Correct Answers: <span id="correctAnswers">0</span></p>
        <p>Correct Answers Percentage: <span id="percentage">0%</span></p> 
        <button class="btn btn-primary" onclick="resetStatistics()">Reset statistics</button>     

        <div class="container">
            <strong>Select tests:</strong>
            <select
                id="selected-tests"
                multiple
                multiselect-search="true" 
                multiselect-select-all="true">
                <option value="budowa_jachtow.json">Budowa jachtów</option>
                <option value="locje.json">Locje</option>
                <option value="teoria_zeglowania.json">Teoria zeglowania</option>
                <option value="testy1.json">Testy 1</option>
                <option value="testy2.json">Testy 2</option>
                <option value="test4.json">Test 4/Test 11</option>
            </select>
        </div>
        <div class="container">
            <select name="field1" id="field1" multiple onchange="console.log(Array.from(this.selectedOptions).map(x=>x.value??x.text))" multiselect-hide-x="true">
                <option value="1">Audi</option>
                <option selected value="2">BMW</option>
                <option selected value="3">Mercedes</option>
                <option value="4">Volvo</option>
                <option value="5">Lexus</option>
                <option value="6">Tesla</option>
              </select>
        </div>
    </div>

    <script>
        var questionsBase = {};
        var questions = [];
        var currentQuestionIndex = -1;
        var feedbackElement = document.getElementById("feedback");
        var hintElement = document.getElementById("hint");
        const localStorageStatsKey = "sailingExamQuizStatistics";
        var answerCheckedFirstTime = true;
        const lastQuestionIndices = []; // Array to store the indices of the last 100 questions


        function displayQuestion() {
            var questionElement = document.getElementById("question");
            var labelA = document.getElementById("labelA");
            var labelB = document.getElementById("labelB");
            var labelC = document.getElementById("labelC");
            labelA.style.color = "";
            labelB.style.color = "";
            labelC.style.color = "";

            if (currentQuestionIndex >= 0 && currentQuestionIndex < questions.length) {
                const currentQuestion = questions[currentQuestionIndex];
                questionElement.textContent = currentQuestion.question;
                labelA.textContent = currentQuestion.answerA;
                labelB.textContent = currentQuestion.answerB;
                labelC.textContent = currentQuestion.answerC;
                feedbackElement.textContent = "";
                hintElement.textContent = "";
                clearSelectedAnswer();
                // Check if image properties exist
                if (currentQuestion.questionImage) {
                    // Set the image source and value
                    const questionImage = document.getElementById("questionImage");
                    questionImage.src = currentQuestion.questionImage;
                    // Show the image container
                    const imageContainer = document.getElementById("imageContainer");
                    imageContainer.style.display = "block";
                    imageContainer.style.maxHeight = "20em";
                    questionImage.style.maxHeight = "20em";
                } else {
                    // Hide the image container
                    const imageContainer = document.getElementById("imageContainer");
                    imageContainer.style.display = "none";
                }
                // Toggle the visibility of the "Show Hint" button
                const hintButton = document.getElementById("hintButton");
                if (currentQuestion.hint) {
                    hintButton.style.display = "inline-block";
                } else {
                    hintButton.style.display = "none";
                }
            } else {
                console.error(`currentQuestionIndex out of available questions: got ${currentQuestionIndex} where have ${questions.length} questions`)
            }
        }

        function checkAnswer() {
            var selectedAnswer = getSelectedAnswer();
            var currentQuestion = questions[currentQuestionIndex];
            const questionAnswerIsCorrect = selectedAnswer === currentQuestion.correctAnswer

            feedbackElement.textContent = questionAnswerIsCorrect ? "Correct!" : `Incorrect. The correct answer is ${currentQuestion.correctAnswer}`

            if (answerCheckedFirstTime) {
                updateStatistics(questionAnswerIsCorrect)
                answerCheckedFirstTime = false;
            }
            showHint();
            highlightCorrectAnswer();
        }

        function nextQuestion() {
            var selectedTests = document.getElementById("selected-tests");
            console.log('#####' + JSON.stringify(selectedTests));
            // Store the index of the answered question in the lastQuestionIndices array
            lastQuestionIndices.push(currentQuestionIndex);
            // Keep the lastQuestionIndices array limited to 100 indices
            if (lastQuestionIndices.length > 100) {
                lastQuestionIndices.shift(); // Remove the oldest index from the beginning of the array
            }
            const availableIndices = questions
                .map((_, index) => index) // Create an array of all question indices
                .filter(index => !lastQuestionIndices.includes(index)); // Exclude the last answered question indices
            // Check if there are available indices
            if (availableIndices.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableIndices.length);
                currentQuestionIndex = availableIndices[randomIndex];
            }
            answerCheckedFirstTime = true;
            displayQuestion();
        }

        function getSelectedAnswer() {
            var answerElements = document.getElementsByName("answer");

            for (var i = 0; i < answerElements.length; i++) {
                if (answerElements[i].checked) {
                    return answerElements[i].value;
                }
            }

            return null;
        }

        function clearSelectedAnswer() {
            var answerElements = document.getElementsByName("answer");

            for (var i = 0; i < answerElements.length; i++) {
                answerElements[i].checked = false;
            }
        }

        function highlightCorrectAnswer() {
            var selectedAnswer = getSelectedAnswer();
            var currentQuestion = questions[currentQuestionIndex];
            var labelA = document.getElementById("labelA");
            var labelB = document.getElementById("labelB");
            var labelC = document.getElementById("labelC");

            if (selectedAnswer === "A") {
                labelA.style.color = currentQuestion.correctAnswer === "A" ? "green" : "red";
            } else {
                labelA.style.color = "";
            }

            if (selectedAnswer === "B") {
                labelB.style.color = currentQuestion.correctAnswer === "B" ? "green" : "red";
            } else {
                labelB.style.color = "";
            }

            if (selectedAnswer === "C") {
                labelC.style.color = currentQuestion.correctAnswer === "C" ? "green" : "red";
            } else {
                labelC.style.color = "";
            }
        }

        function searchQuestion() {
            var currentQuestion = questions[currentQuestionIndex];
            var googleSearchUrl = "https://www.google.com/search?q=" + encodeURIComponent(currentQuestion.question);
            window.open(googleSearchUrl, "_blank");
        }

        // Function to show the hint
        function showHint() {
            const currentQuestion = questions[currentQuestionIndex];
            const hint = currentQuestion.hint != undefined ? currentQuestion.hint : "No hint for given question";
            document.getElementById("hint").textContent = hint;
        }

        function retrieveOrInitStatistics() {
            const localStorageStats = localStorage.getItem(localStorageStatsKey);
            if (localStorageStats) {
                return JSON.parse(localStorageStats);
            } else {
                const statistics = {
                    totalQuestions: 0,
                    correctAnswers: 0
                };
                localStorage.setItem(localStorageStatsKey, JSON.stringify(statistics));
                return statistics;
            }
        }

        function displayStatistic(statistics) {
            // Calculate the percentage of correct answers
            const percentage = (statistics.correctAnswers / statistics.totalQuestions) * 100;
            // Display the statistics
            document.getElementById("totalQuestions").textContent = statistics.totalQuestions;
            document.getElementById("correctAnswers").textContent = statistics.correctAnswers;
            document.getElementById("percentage").textContent = percentage.toFixed(2) + "%";
        }

        // Function to update and display the statistics
        function updateStatistics(questionAnswerIsCorrect) {
            // Retrieve statistics from local storage
            const statistics = retrieveOrInitStatistics();

            // Update the statistics
            statistics.totalQuestions++;
            if (questionAnswerIsCorrect) {
                statistics.correctAnswers++;
            }

            // Store the updated statistics in local storage
            localStorage.setItem(localStorageStatsKey, JSON.stringify(statistics));
            displayStatistic(statistics);
        }

        // Reset the statistics
        function resetStatistics() {
            const statistics = {
                totalQuestions: 0,
                correctAnswers: 0
            };
            localStorage.setItem(localStorageStatsKey, JSON.stringify(statistics));
            displayStatistic(statistics);
        }

        function fetchQuizDataAndStart() {
            const questionsFiles = [
                'budowa_jachtow.json',
                'locje.json',
                'teoria_zeglowania.json',
                'testy1.json',
                'testy2.json',
                'test4.json'
            ];
            try {
                Promise.all(questionsFiles.map(file => fetch(`https://raw.githubusercontent.com/sebarys/SailingExam/main/questions_base/${file}`)))
                    .then(results => Promise.all(results.map(response => response.json())))
                    .then(data => {
                        data.map((questions, index) =>
                            questionsBase[questionsFiles[index]] = questions
                        );
                        // console.log(JSON.stringify(questionsBase))
                        retrieveOrInitStatistics();
                        nextQuestion();
                    });
            } catch (error) {
                console.error('Error fetching quiz data:', error);
            }
        }

        fetchQuizDataAndStart();
    </script>
</body>
</html>
