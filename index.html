<!DOCTYPE html>
<html>
<head>
    <title>Å»eglarz jachtowy egzamin pytania</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
    <style>
        .container {
            text-align: center;
            margin-top: 50px;
            font-size: 18px;
        }
        .question {
            margin-bottom: 20px;
        }
        .answers {
            margin-bottom: 20px;
        }
        .feedback {
            margin-bottom: 20px;
        }
        .next-button {
            margin-bottom: 20px;
        }
        .search-button {
            margin-bottom: 20px;
        }
        .hint {
            margin-top: 10px;
        }
        select {
            width: 20em;
        }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8" crossorigin="anonymous"></script>
    <script src="https://raw.githubusercontent.com/admirhodzic/multiselect-dropdown/main/multiselect-dropdown.js" ></script>

    <div class="container">
        <div class="info" id="info" style="color:red"></div>
        <div class="question" id="question"></div>
        <div id="imageContainer">
            <img id="questionImage" src="" alt="Question Image">
        </div>
        <div class="answers">
            <label for="answerA"><input type="radio" name="answer" value="A" id="answerA"> <span id="labelA"></span></label><br>
            <label for="answerB"><input type="radio" name="answer" value="B" id="answerB"> <span id="labelB"></span></label><br>
            <label for="answerC"><input type="radio" name="answer" value="C" id="answerC"> <span id="labelC"></span></label><br>
        </div>
        <button class="btn btn-primary" onclick="checkAnswer()">Check Answer</button>
        <div class="feedback" id="feedback"></div>
        <div class="hint" id="hint"></div>
        <button class="btn btn-primary" onclick="nextQuestion()">Next</button>
        <button class="btn btn-primary" onclick="searchQuestion()">Search in Google</button>
        <button class="btn btn-primary" onclick="showHint()" id="hintButton" style="display: none;">Show Hint</button>
        <p>Total Questions: <span id="totalQuestions">0</span></p>
        <p>Correct Answers: <span id="correctAnswers">0</span></p>
        <p>Correct Answers Percentage: <span id="percentage">0%</span></p> 
        <button class="btn btn-primary" onclick="resetStatistics()">Reset statistics</button>     

        <div class="container">
            <strong>Select tests:</strong>
            <select
                id="selected-tests"
                multiple
                multiselect-search="true" 
                multiselect-select-all="true">
                <option selected value="budowa_jachtow.json">Budowa jachtow</option>
                <option selected value="locje.json">Locje</option>
                <option selected value="teoria_zeglowania.json">Teoria zeglowania</option>
                <option selected value="testy1.json">Testy 1</option>
                <option selected value="testy2.json">Testy 2</option>
                <option selected value="test4.json">Test 4/Test 11</option>
                <option value="recent-wrong-answers">Recent wrong answers</option>
            </select>
        </div>
    </div>

    <script>
        var questionsBase = {};
        var questions = [];
        var currentQuestion = {};
        var feedbackElement = document.getElementById("feedback");
        var hintElement = document.getElementById("hint");
        const localStorageStatsKey = "sailingExamQuizStatistics";
        const recentWrongAnswerSelectboxKey = "recent-wrong-answers";
        var answerCheckedFirstTime = true;
        const lastQuestions = []; // Array to store the indices of the last 100 questions
        var currentlySelectedTests = [];


        function displayQuestion() {
            var questionElement = document.getElementById("question");
            var labelA = document.getElementById("labelA");
            var labelB = document.getElementById("labelB");
            var labelC = document.getElementById("labelC");
            labelA.style.color = "";
            labelB.style.color = "";
            labelC.style.color = "";
            if (currentQuestion) {
                questionElement.textContent = currentQuestion.question;
                labelA.textContent = currentQuestion.answerA;
                labelB.textContent = currentQuestion.answerB;
                labelC.textContent = currentQuestion.answerC;
                feedbackElement.textContent = "";
                hintElement.textContent = "";
                clearSelectedAnswer();
                // Check if image properties exist
                if (currentQuestion.questionImage) {
                    // Set the image source and value
                    const questionImage = document.getElementById("questionImage");
                    questionImage.src = currentQuestion.questionImage;
                    // Show the image container
                    const imageContainer = document.getElementById("imageContainer");
                    imageContainer.style.display = "block";
                    imageContainer.style.maxHeight = "20em";
                    questionImage.style.maxHeight = "20em";
                } else {
                    // Hide the image container
                    const imageContainer = document.getElementById("imageContainer");
                    imageContainer.style.display = "none";
                }
                // Toggle the visibility of the "Show Hint" button
                const hintButton = document.getElementById("hintButton");
                if (currentQuestion.hint) {
                    hintButton.style.display = "inline-block";
                } else {
                    hintButton.style.display = "none";
                }
            } else {
                console.error(`currentQuestion not defined: got ${currentQuestion} where have ${questions.length} questions`)
            }
        }

        function checkAnswer() {
            var selectedAnswer = getSelectedAnswer();
            const questionAnswerIsCorrect = selectedAnswer === currentQuestion.correctAnswer

            feedbackElement.textContent = questionAnswerIsCorrect ? "Correct!" : `Incorrect. The correct answer is ${currentQuestion.correctAnswer}`

            if (answerCheckedFirstTime) {
                updateStatistics(questionAnswerIsCorrect)
                answerCheckedFirstTime = false;
            }
            showHint();
            highlightCorrectAnswer();
        }

        function updateQuestionsListIfNeeded() {
            const selectedTests = Array.from(
                document.getElementById("selected-tests").selectedOptions
            ).map(option=>option.value??option.text)

            const selectedSetsAreTheSame = arraysContainsTheSameElements(selectedTests, currentlySelectedTests);
            const testsIncludeWrongAnswersCollection = selectedTests.includes(recentWrongAnswerSelectboxKey);

            if (!selectedSetsAreTheSame || testsIncludeWrongAnswersCollection) {
                console.log(`Detected need to update questions list, selected tests are equal: ${selectedSetsAreTheSame}, include wrong answers ${testsIncludeWrongAnswersCollection}`);
                updateQuestionsList();
            } 
        }

        // based on user configuration pick what questions should be included in questions list that we use to pick next question
        function updateQuestionsList() {
            const selectedTests = Array.from(
                document.getElementById("selected-tests").selectedOptions
            ).map(option=>option.value??option.text)
            console.log(`Previously selected tests: ${JSON.stringify(currentlySelectedTests)}, currenlty selected tests: ${JSON.stringify(selectedTests)}`);
            currentlySelectedTests = selectedTests;
            // TODO remove duplicate questions based on `(question text (without number), image link)` or `(question text, answers)` tuple - different tests can have the same question
            let availableQuestions = selectedTests
                .map(testName => questionsBase[testName])
                .flat()
            if (selectedTests.includes(recentWrongAnswerSelectboxKey)) {
                const statistics = retrieveOrInitStatistics()
                availableQuestions = availableQuestions.concat(statistics.recentlyWrongAnsweredQuestions);
            }
            console.log(`Updated questions list to have only questions from ${JSON.stringify(selectedTests)}. Previous questions set length ${questions.length}, updated questions set length ${availableQuestions.length}`);
            questions = availableQuestions;
            return availableQuestions;
        }

        function nextQuestion() {
            updateQuestionsListIfNeeded();
            const infoElement = document.getElementById("info");
            // Store info about the answered question in the lastQuestions array
            // TODO last questions should be also persisted in local storage
            lastQuestions.push(currentQuestion);
            // Keep the info about last 100 answered questions 
            if (lastQuestions.length > 100) {
                lastQuestions.shift(); // Remove the oldest question from the beginning of the array
            }
            // Exclude the last answered question from available questions 
            const availableQuestions = questions.filter(question => !lastQuestions.includes(question)); 
            // Pick next question from availableQuestions
            if (availableQuestions.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                currentQuestion = availableQuestions[randomIndex];
                infoElement.textContent = "";
            } else {
                console.warn("Available questions array is empty!");
                infoElement.textContent = "Based on selected tests available questions set is empty, please update selected tests before clicking 'Next' button!";
            }
            answerCheckedFirstTime = true;
            displayQuestion();
        }

        function getSelectedAnswer() {
            var answerElements = document.getElementsByName("answer");

            for (var i = 0; i < answerElements.length; i++) {
                if (answerElements[i].checked) {
                    return answerElements[i].value;
                }
            }

            return null;
        }

        function clearSelectedAnswer() {
            var answerElements = document.getElementsByName("answer");

            for (var i = 0; i < answerElements.length; i++) {
                answerElements[i].checked = false;
            }
        }

        function highlightCorrectAnswer() {
            var selectedAnswer = getSelectedAnswer();
            var labelA = document.getElementById("labelA");
            var labelB = document.getElementById("labelB");
            var labelC = document.getElementById("labelC");

            if (selectedAnswer === "A") {
                labelA.style.color = currentQuestion.correctAnswer === "A" ? "green" : "red";
            } else {
                labelA.style.color = "";
            }

            if (selectedAnswer === "B") {
                labelB.style.color = currentQuestion.correctAnswer === "B" ? "green" : "red";
            } else {
                labelB.style.color = "";
            }

            if (selectedAnswer === "C") {
                labelC.style.color = currentQuestion.correctAnswer === "C" ? "green" : "red";
            } else {
                labelC.style.color = "";
            }
        }

        function searchQuestion() {
            var googleSearchUrl = "https://www.google.com/search?q=" + encodeURIComponent(currentQuestion.question);
            window.open(googleSearchUrl, "_blank");
        }

        // Function to show the hint
        function showHint() {
            const hint = currentQuestion.hint != undefined ? currentQuestion.hint : "No hint for given question";
            document.getElementById("hint").textContent = hint;
        }

        function retrieveOrInitStatistics() {
            const localStorageStats = localStorage.getItem(localStorageStatsKey);
            if (localStorageStats) {
                return JSON.parse(localStorageStats);
            } else {
                const statistics = {
                    totalQuestions: 0,
                    correctAnswers: 0,
                    recentlyWrongAnsweredQuestions: []
                };
                localStorage.setItem(localStorageStatsKey, JSON.stringify(statistics));
                return statistics;
            }
        }

        function displayStatistic(statistics) {
            // Calculate the percentage of correct answers
            const percentage = (statistics.correctAnswers / statistics.totalQuestions) * 100;
            // Display the statistics
            document.getElementById("totalQuestions").textContent = statistics.totalQuestions;
            document.getElementById("correctAnswers").textContent = statistics.correctAnswers;
            document.getElementById("percentage").textContent = percentage.toFixed(2) + "%";
        }

        // Function to update and display the statistics
        function updateStatistics(questionAnswerIsCorrect) {
            // Retrieve statistics from local storage
            const statistics = retrieveOrInitStatistics();

            // Update the statistics
            statistics.totalQuestions++;
            if (questionAnswerIsCorrect) {
                statistics.correctAnswers++;
                if (statistics.recentlyWrongAnsweredQuestions) {
                    // we need remove correctly answered question from recentlyWrongAnsweredQuestions list
                    statistics.recentlyWrongAnsweredQuestions = statistics.recentlyWrongAnsweredQuestions
                        .filter(question => !areQuestionsEqual(question, currentQuestion));
                }
            } else {
                if(statistics.length > 50) {
                    statistics.recentlyWrongAnsweredQuestions.shift()
                }
                if (statistics.recentlyWrongAnsweredQuestions) {
                    // we add wrongly answered question to recentlyWrongAnsweredQuestions list only if it is not present there yet
                    if (statistics.recentlyWrongAnsweredQuestions.filter(question => areQuestionsEqual(question, currentQuestion)).length == 0) {
                        statistics.recentlyWrongAnsweredQuestions.push(currentQuestion);
                    }
                } else {
                    statistics.recentlyWrongAnsweredQuestions = [currentQuestion];
                }
                
            }

            // Store the updated statistics in local storage
            localStorage.setItem(localStorageStatsKey, JSON.stringify(statistics));
            displayStatistic(statistics);
        }

        // Reset the statistics
        function resetStatistics() {
            const statistics = {
                totalQuestions: 0,
                correctAnswers: 0
            };
            localStorage.setItem(localStorageStatsKey, JSON.stringify(statistics));
            displayStatistic(statistics);
        }

        function fetchQuizDataAndStart() {
            const questionsFiles = [
                'budowa_jachtow.json',
                'locje.json',
                'teoria_zeglowania.json',
                'testy1.json',
                'testy2.json',
                'test4.json'
            ];
            try {
                Promise.all(questionsFiles.map(file => fetch(`https://raw.githubusercontent.com/sebarys/SailingExam/main/questions_base/${file}`)))
                    .then(results => Promise.all(results.map(response => response.json())))
                    .then(data => {
                        data.map((questions, index) =>
                            questionsBase[questionsFiles[index]] = questions
                        );
                        retrieveOrInitStatistics();
                        updateQuestionsList();
                        nextQuestion();
                    });
            } catch (error) {
                console.error('Error fetching quiz data:', error);
            }
        }

        function areQuestionsEqual(question1, question2) {
            return question1.question === question2.question &&
                question1.answerA === question2.answerA &&
                question1.answerB === question2.answerB &&
                question1.answerC === question2.answerC &&
                question1.correctAnswer === question2.correctAnswer &&
                question1.hint === question2.hint &&
                question1.questionImage === question2.questionImage;
        }

        function arraysContainsTheSameElements(arr1, arr2) {
            const arr1AsSet = new Set(arr1);
            const arr2AsSet = new Set(arr2);
            if (arr1AsSet.size !== arr2AsSet.size) {
                return false;
            }

            return Array.from(arr1AsSet).every(element => {
                return arr2AsSet.has(element);
            });
        }

        fetchQuizDataAndStart();
    </script>
</body>
</html>
